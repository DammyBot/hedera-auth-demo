<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashPack Integration Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .info-box {
            background: #fff3cd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê HashPack + Hedera Auth Integration</h1>
        
        <div class="info-box">
            <strong>‚ö†Ô∏è Important:</strong> This example requires the HashPack browser extension to be installed.
            <br>
            Download from: <a href="https://www.hashpack.app/" target="_blank">hashpack.app</a>
        </div>

        <div>
            <h3>Configuration</h3>
            <label>Server URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:3000" style="width: 100%; padding: 8px; margin: 10px 0;">
        </div>

        <div style="margin: 20px 0;">
            <button id="connectBtn" onclick="connectWallet()">1. Connect HashPack Wallet</button>
            <button id="authBtn" onclick="authenticate()" disabled>2. Authenticate with Server</button>
            <button id="profileBtn" onclick="getProfile()" disabled>3. Get Profile</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div id="details" style="margin-top: 20px;"></div>

        <div style="margin-top: 30px;">
            <h3>How it works:</h3>
            <ol>
                <li>Click "Connect HashPack Wallet" to connect your wallet</li>
                <li>Your Hedera account will be detected</li>
                <li>Click "Authenticate with Server" to sign a challenge message</li>
                <li>Receive a JWT token for authenticated requests</li>
                <li>Click "Get Profile" to test authenticated API calls</li>
            </ol>
        </div>
    </div>

    <script>
        let accountId = null;
        let authToken = null;
        const serverUrl = document.getElementById('serverUrl').value;

        function showStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function showDetails(data) {
            const detailsDiv = document.getElementById('details');
            detailsDiv.innerHTML = `<h3>Details:</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function connectWallet() {
            showStatus('Connecting to HashPack...', 'status');
            
            try {
                // Check if HashPack is installed
                if (!window.hashconnect) {
                    showStatus('‚ùå HashPack extension not found. Please install it from hashpack.app', 'error');
                    return;
                }

                // For this example, we'll use a simpler approach
                // In production, use the full HashConnect SDK
                
                // Check if HashPack is available via window.ethereum-like interface
                if (typeof window.hashconnect !== 'undefined') {
                    showStatus('‚úÖ HashPack detected! Please follow wallet prompts...', 'success');
                    
                    // This is a simplified example
                    // In production, implement full HashConnect protocol
                    showStatus(
                        '‚ö†Ô∏è This is a demonstration UI. For production:<br>' +
                        '1. Install HashConnect SDK: <code>npm install hashconnect</code><br>' +
                        '2. Implement proper pairing flow<br>' +
                        '3. See: <a href="https://github.com/Hashpack/hashconnect" target="_blank">HashConnect Documentation</a>',
                        'status'
                    );
                    
                    // For demo purposes, allow manual entry
                    const manualAccountId = prompt('For this demo, enter your Hedera Account ID (e.g., 0.0.12345):');
                    if (manualAccountId) {
                        accountId = manualAccountId;
                        showStatus(`‚úÖ Connected: ${accountId}`, 'success');
                        document.getElementById('authBtn').disabled = false;
                        showDetails({ accountId });
                    }
                } else {
                    showStatus('‚ùå Please install HashPack extension', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function authenticate() {
            if (!accountId) {
                showStatus('‚ùå Please connect wallet first', 'error');
                return;
            }

            showStatus('Requesting challenge from server...', 'status');
            
            try {
                // Step 1: Get challenge
                const challengeResponse = await fetch(`${serverUrl}/auth/challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountId })
                });

                const challengeData = await challengeResponse.json();
                
                if (!challengeData.success) {
                    showStatus(`‚ùå Challenge failed: ${challengeData.error}`, 'error');
                    return;
                }

                const challenge = challengeData.data.challenge;
                showStatus(`üìù Challenge received. Please sign in HashPack...`, 'status');
                showDetails({ challenge });

                // Step 2: Sign challenge with HashPack
                // In a real implementation, use HashConnect to sign
                // For demo, we'll simulate this
                
                showStatus(
                    '‚ö†Ô∏è Demo Mode: In production, HashPack will sign the message automatically.<br>' +
                    'For testing, you need to:<br>' +
                    '1. Copy the challenge message above<br>' +
                    '2. Sign it with your Hedera wallet/SDK<br>' +
                    '3. Use the verify endpoint with the signature<br><br>' +
                    '<strong>Implementation Example:</strong><br>' +
                    '<code>const signature = await hashconnect.sign(challenge);</code>',
                    'status'
                );

                // For a real implementation, you would do:
                /*
                const signedMessage = await window.hashconnect.sendTransaction({
                    topic: connectionTopic,
                    byteArray: Buffer.from(challenge),
                    metadata: { accountToSign: accountId }
                });

                // Step 3: Verify signature
                const verifyResponse = await fetch(`${serverUrl}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId,
                        signature: signedMessage.signature,
                        publicKey: signedMessage.publicKey
                    })
                });

                const verifyData = await verifyResponse.json();
                
                if (verifyData.success) {
                    authToken = verifyData.data.token;
                    showStatus('‚úÖ Authentication successful!', 'success');
                    document.getElementById('profileBtn').disabled = false;
                    showDetails({ token: authToken, accountId });
                } else {
                    showStatus(`‚ùå Verification failed: ${verifyData.error}`, 'error');
                }
                */

            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function getProfile() {
            if (!authToken) {
                showStatus('‚ùå Please authenticate first', 'error');
                return;
            }

            showStatus('Fetching profile...', 'status');

            try {
                const response = await fetch(`${serverUrl}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus('‚úÖ Profile loaded successfully!', 'success');
                    showDetails(data.data);
                } else {
                    showStatus(`‚ùå Failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Update server URL on change
        document.getElementById('serverUrl').addEventListener('change', (e) => {
            serverUrl = e.target.value;
        });
    </script>

    <div style="margin-top: 40px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
        <h3>üìö Production Implementation Guide</h3>
        
        <h4>1. Install HashConnect</h4>
        <pre>npm install hashconnect</pre>

        <h4>2. Initialize HashConnect</h4>
        <pre>
import { HashConnect } from 'hashconnect';

const hashconnect = new HashConnect();
const appMetadata = {
    name: "Your Game Name",
    description: "Your game description",
    icon: "https://yourgame.com/icon.png"
};

await hashconnect.init(appMetadata);</pre>

        <h4>3. Pair with Wallet</h4>
        <pre>
hashconnect.pairingEvent.on((data) => {
    console.log('Paired!', data);
    accountId = data.accountIds[0];
});</pre>

        <h4>4. Sign Message</h4>
        <pre>
const message = Buffer.from(challenge, 'utf8');
const result = await hashconnect.sendTransaction(
    pairingData.topic,
    {
        byteArray: message,
        metadata: {
            accountToSign: accountId,
            returnTransaction: false
        }
    }
);</pre>

        <h4>5. Full Example Repository</h4>
        <p>For a complete working example with HashConnect, see:</p>
        <ul>
            <li><a href="https://github.com/Hashpack/hashconnect" target="_blank">HashConnect GitHub</a></li>
            <li><a href="https://docs.hashpack.app/" target="_blank">HashPack Documentation</a></li>
        </ul>
    </div>
</body>
</html>
